#include <Wire.h>
#include "AS5600.h"
// AS5600 I2C地址
#define AS5600_ADDR 0x36
AS5600 as5600;   //  use default Wire

// MX1508电机驱动模块
#define MOTOR_A_IN1_PIN 2  // 电机A输入1引脚
#define MOTOR_A_IN2_PIN 3  // 电机A输入2引脚

// PID参数设置
double kp = 0.5;   // 比例系数
double ki = 0.001;   // 积分系数
double kd = 1.7;   // 微分系数

// 目标角度和当前角度变量
double targetAngle = 150;   // 目标角度
double currentAngle = 0;   // 当前角度

// PID控制变量
double setpoint = 0;   // 设定值（偏差）
double error = 0;      // 误差
double prev_error = 0; // 上一个误差
double integral = 0;   // 积分项
double derivative = 0; // 微分项
int output = 0;        // PID输出值

void setup() {
  Serial.begin(115200);
  Serial.println(__FILE__);
  Serial.print("AS5600_LIB_VERSION: ");
  Serial.println(AS5600_LIB_VERSION);

  //  ESP32
  //  as5600.begin(14,15);
  //  AVR
  as5600.begin(4);  //  set direction pin.
  as5600.setDirection(AS5600_CLOCK_WISE);  // default, just be explicit.
  int b = as5600.isConnected();
  Serial.print("Connect: ");
  Serial.println(b);
  delay(1000);

    // 读取当前角度
 currentAngle =( as5600.rawAngle() * AS5600_RAW_TO_DEGREES);
  //Serial.print(currentAngle);

  // 计算偏差
  error = targetAngle - currentAngle;

   //Serial.print(error);
  //Serial.print("\t");
 
  delay(1000);

   pinMode(MOTOR_A_IN1_PIN, OUTPUT);
  pinMode(MOTOR_A_IN2_PIN, OUTPUT);

   digitalWrite(MOTOR_A_IN2_PIN, LOW); // 正转
    analogWrite(MOTOR_A_IN1_PIN, 255);
    delay(500);  // 延时2秒
               }
                             
void loop() {
    
  
  // 读取当前角度
  currentAngle = ( as5600.rawAngle() * AS5600_RAW_TO_DEGREES);
   Serial.print(currentAngle);
  Serial.print("\t");

  // 计算偏差
  error = targetAngle - currentAngle;

  // PID控制
  setpoint = kp * error + ki * integral + kd * derivative;
   if (setpoint > 0) {
    setpoint=setpoint; 
   
} else if (setpoint < 0) {
    setpoint=setpoint; 
    
} 
  
  // 更新误差和输出值
  prev_error = error;
  integral += error;
  derivative = error - prev_error;

  // 限制输出值范围
  Serial.print(error);
  Serial.print("\t");
  Serial.print(setpoint);
  Serial.print("\t");
  output = constrain(setpoint, -255, 255);    
  Serial.print(output);
  Serial.print("\t");

  // 控制电机运动
 if (output > 0) {
    digitalWrite(MOTOR_A_IN2_PIN, LOW); // 正转
    analogWrite(MOTOR_A_IN1_PIN, output+23);
} else if (output < 0) {
    digitalWrite(MOTOR_A_IN1_PIN, LOW); // 反转
    analogWrite(MOTOR_A_IN2_PIN, abs(output-23));
} else {
    digitalWrite(MOTOR_A_IN1_PIN, LOW);
    digitalWrite(MOTOR_A_IN2_PIN, LOW);
}

  //Serial.print(as5600.readAngle());
  //Serial.print("\t");
  delay(10);  // 延时2秒
}
   